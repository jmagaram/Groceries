@page "/storeedit"
@page "/storeedit/{ID}"
@implements IDisposable
@using System.Reactive.Linq;
@using Data; 
@using Models;
@using static Common.OptionExtensions;
@using static Models.StoreEditFormModule.StoreEditFormExtensions;

<style>
    .nav-pills li {
        margin-right: 5px;
    }
</style>

@if (Form.Mode().IsCreateNewStoreMode) {
    <h3>New store</h3>
}
else {
    <h3>Edit store</h3>
}

<form>
    <div class="form-group">
        <label for="storeNameInput">Store name</label>
        <input id="storeNameInput" class="form-control" @oninput="OnNameChange" @onfocusout="OnNameFocusOut" value="@Form.StoreName.ValueCommitted" />
        @if (Form.StoreNameErrors().IsSome()) {
            <small class="form-text text-danger">
                @Form.StoreNameErrors().Value
            </small>
        }
    </div>

    <ul class="nav nav-pills">
        @if (Form.Mode().IsEditExistingStoreMode) {
            <li>
                <button class="btn btn-secondary" type="button" @onclick="e=>OnDelete()"><span class="oi oi-trash" aria-hidden="true"></span></button>
            </li>
        }
        <li>
            <button class="btn btn-primary" type="button" @onclick="OnSubmit" disabled="@(Form.HasErrors())">Submit</button>
        </li>
    </ul>
</form>

@code {
    IDisposable _subscription = null;

    public void Dispose() => _subscription?.Dispose();

    protected override void OnInitialized() {
        _subscription = StateService.StoreEditPage.Subscribe(i => Form = i);
        if (!string.IsNullOrWhiteSpace(Id)) {
            var pageMessage = StateTypes.StoreEditPageMessage.NewBeginEditStore(Id);
            var stateMessage = StateTypes.StateMessage.NewStoreEditPageMessage(pageMessage);
            StateService.Update(stateMessage);
        }
        else {
            var pageMessage = StateTypes.StoreEditPageMessage.BeginCreateNewStore;
            var stateMessage = StateTypes.StateMessage.NewStoreEditPageMessage(pageMessage);
            StateService.Update(stateMessage);
        }
    }

    [Inject]
    public ApplicationStateService StateService { get; set; }

    [Inject]
    NavigationManager Navigation { get; set; }

    [Parameter]
    public string Id { get; set; }

    protected StateTypes.StoreEditForm Form { get; set; }

    protected void OnNameChange(ChangeEventArgs e) {
        var textBoxMessage = StateTypes.TextBoxMessage.NewTypeText((string)e.Value);
        var formMessage = StateTypes.StoreEditFormMessage.NewStoreNameMessage(textBoxMessage);
        var pageMessage = StateTypes.StoreEditPageMessage.NewStoreEditFormMessage(formMessage);
        var stateMessage = StateTypes.StateMessage.NewStoreEditPageMessage(pageMessage);
        StateService.Update(stateMessage);
    }

    protected void OnNameFocusOut(FocusEventArgs e) {
        var textBoxMessage = StateTypes.TextBoxMessage.LoseFocus;
        var formMessage = StateTypes.StoreEditFormMessage.NewStoreNameMessage(textBoxMessage);
        var pageMessage = StateTypes.StoreEditPageMessage.NewStoreEditFormMessage(formMessage);
        var stateMessage = StateTypes.StateMessage.NewStoreEditPageMessage(pageMessage);
        StateService.Update(stateMessage);
    }

    protected void OnDelete() {
        var pageMessage = StateTypes.StoreEditPageMessage.DeleteStore;
        var stateMessage = StateTypes.StateMessage.NewStoreEditPageMessage(pageMessage);
        StateService.Update(stateMessage);
        Navigation.NavigateTo("shoppinglist");
    }

    protected void OnSubmit() {
        var pageMessage = StateTypes.StoreEditPageMessage.SubmitStoreEditForm;
        var stateMessage = StateTypes.StateMessage.NewStoreEditPageMessage(pageMessage);
        StateService.Update(stateMessage);
        Navigation.NavigateTo("shoppinglist");
    }

    protected void OnCancel() {
        var pageMessage = StateTypes.StoreEditPageMessage.CancelStoreEditForm;
        var stateMessage = StateTypes.StateMessage.NewStoreEditPageMessage(pageMessage);
        StateService.Update(stateMessage);
        Navigation.NavigateTo("shoppinglist");
    }
}
